#!/bin/sh
# Copyright (c) 2008 by Xuggle Inc. All rights reserved.
#
# It is REQUESTED BUT NOT REQUIRED if you use this library, that you let 
# us know by sending e-mail to info\@xuggle.com telling us briefly how you're
# using the library and what you like or don't like about it.
#
# This library is free software; you can redistribute it and/or modify it under the
# terms of the GNU Lesser General Public License as published by the Free Software
# Foundation; either version 2.1 of the License, or (at your option) any later
# version.
#
# This library is distributed in the hope that it will be useful, but WITHOUT ANY
# WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A
# PARTICULAR PURPOSE. See the GNU Lesser General Public License for more details.
#
# You should have received a copy of the GNU Lesser General Public License along
# with this library; if not, write to the Free Software Foundation, Inc.,
# 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA
# This file contains global rules that all Makefiles should know about.
# It should NOT be generated by AutoMake, but should be generated by Autoconf

# Run's java but using all the jars in the distribution's lib directory in
# the classpath.  Also adds Red5's jars if needed.
# Usage: $0 java-class
OS=`uname`
echo "Running on: $OS"

if [ $VS_VALGRIND_MEMCHECK ]; then
  COMMAND="valgrind --tool=memcheck --leak-check=full --show-reachable=yes --smc-check=all --trace-children=yes -v -- java -Xmx1000m"
else if [ $VS_VALGRIND_GRIND ]; then
  COMMAND="valgrind --tool=callgrind --dump-instr=yes --trace-jump=yes -- java -Xmx1000m"
else
  COMMAND="java"
fi
fi

mypath=../../..
if [ $OS = "CYGWIN_NT-6.0" ]; then
  PATH_CONV="cygpath -d"
  echo "Converting paths with: $PATH_CONV"
  mypath=`cygpath -u $mypath`
  SEP=";"
else
  SEP=":"
  PATH_CONV=echo
fi

classpath=`$PATH_CONV $mypath/build/test`$SEP`$PATH_CONV $mypath/build/classes`
for jar in $mypath/build/lib/test/*.jar; do
  classpath=$classpath$SEP`$PATH_CONV "$jar"`
done
if [ ! -z "$RED5_HOME" ]; then
  classpath=$classpath$SEP`$PATH_CONV "$RED5_HOME"/red5.jar`
fi

shared_object_path=$mypath/dist/stage$XUGGLE_HOME
export PATH=$shared_object_path/bin:$PATH
export LD_LIBRARY_PATH=$shared_object_path/lib:$LD_LIBRARY_PATH
echo "LD_LIBRARY_PATH=$LD_LIBRARY_PATH"
export DYLD_LIBRARY_PATH=$shared_object_path/lib:$DYLD_LIBRARY_PATH

export CLASSPATH=$classpath;

if [ -z "$JAVA_OPTS" ]; then
  export JAVA_OPTS=
fi
if [ $VS_JAVA_MEMCHECK ]; then
  export JAVA_OPTS="$JAVA_OPTS -agentlib:hprof=heap=all,lineno=y,thread=y,format=b"
fi
if [ $VS_JAVA_WAITFORNATIVEDEBUGGER ]; then
  JAVA_OPTS="$JAVA_OPTS -com.xuggle.ferry.WaitForDebugger=1"
fi

#echo "CLASSPATH=$classpath";
echo $COMMAND $JAVA_OPTS $*
$COMMAND -ea $JAVA_OPTS $*
