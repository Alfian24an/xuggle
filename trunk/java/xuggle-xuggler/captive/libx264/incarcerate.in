#!/bin/sh

# Modify this script to pass the necessary parameters to 
# the configure of the captive package you're configuring
prefix="@prefix@"
exec_prefix="@exec_prefix@"
X264_OPTIONS=
LDFLAGS="@LDFLAGS@"
CFLAGS="@CFLAGS@"
YASM="@YASM@"
HOST_TYPE=@HOST_TYPE@
HOST_OS=@HOST_OS@
VS_DEBUG=@VS_DEBUG@

VS_ENABLE_64BIT=@VS_ENABLE_64BIT@
case $HOST_TYPE in
  Windows)
  CC="${CC} -mno-cygwin"
  LDFLAGS="$LDFLAGS -mno-cygwin"
  CFLAGS="$CFLAGS -fno-common"
  X264_OPTIONS="$X264_OPTIONS --extra-cflags=-fno-common"
  X264_OPTIONS="$X264_OPTIONS --disable-pthread"
  ;;
  Mac)
  CFLAGS="$CFLAGS -fno-common"
  X264_OPTIONS="$X264_OPTIONS --extra-cflags=-fno-common"
  ;;
  *)
  ;;
esac
if test "x$VS_ENABLE_64BIT" = "xyes"; then
  ASFLAGS="$ASFLAGS -machine=amd64"
  X264_OPTIONS="$X264_OPTIONS --extra-asflags=-machine=amd64"
  CFLAGS="$CFLAGS -m64"
  X264_OPTIONS="$X264_OPTIONS --extra-cflags=-m64"
  LDFLAGS="$LDFLAGS -m64"
  X264_OPTIONS="$X264_OPTIONS --extra-ldflags=-m64"
  case $HOST_TYPE in
    Mac)
    CFLAGS="$CFLAGS -arch x86_64"
    X264_OPTIONS="$X264_OPTIONS --extra-cflags=-arch"
    X264_OPTIONS="$X264_OPTIONS --extra-cflags=x86_64"
    LDFLAGS="$LDFLAGS -arch x86_64"
    X264_OPTIONS="$X264_OPTIONS --extra-ldflags=-arch"
    X264_OPTIONS="$X264_OPTIONS --extra-ldflags=x86_64"
    X264_OPTIONS="$X264_OPTIONS --host=x86_64-apple-darwin"
    ;;
    *)
    ;;
  esac
fi

# Tell X264 about the captive libraries already built and fake
# installed

X264_OPTIONS="$X264_OPTIONS --enable-pic --enable-shared"
if test ! "x$VS_DEBUG" = "x"; then
  echo "Creating debug version of libx264: $VS_DEBUG"
  X264_OPTIONS="$X264_OPTIONS --disable-asm"
  X264_OPTIONS="$X264_OPTIONS --enable-debug"
else
  echo "Creating release version of libx264: $VS_DEBUG"
fi

if test "x$YASM" = "x"; then
# no assembly for us :(
  X264_OPTIONS="$X264_OPTIONS --disable-asm"
fi

# libx264 doesn't support VPATH builds, so we fake it
echo "Copying @abs_srcdir@/csrc to @abs_builddir@/csrc"
# create the directory
mkdir -p @abs_builddir@/csrc
# copy over all the source
cp -r @abs_srcdir@/csrc/* @abs_builddir@/csrc/
# and make everything user writeable so distcheck will pass
chmod -R u+w @abs_builddir@/csrc/*

echo "Configuring X264 with these options: $X264_OPTIONS"
sh @abs_builddir@/csrc/configure \
  --extra-cflags="$CFLAGS -I'@abs_top_builddir@/captive@includedir@'" \
  --extra-ldflags="$LDFLAGS -L'@abs_top_builddir@/captive@libdir@'" \
  --prefix="${prefix}" $X264_OPTIONS || \
  (echo "Could not configure library: \"@abs_srcdir@\"; you may want to try disabling it or installing your own version" && exit 1)
